<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <title>Panel Empleado - Diamante Azul</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; }

        /* SIDEBAR (Barra Lateral) */
        .sidebar {
            height: 100vh; width: 240px; position: fixed; top: 0; left: 0;
            background: #212529; color: white; padding-top: 70px; z-index: 900;
            transition: 0.3s;
        }
        .sidebar a {
            padding: 12px 20px; display: block; color: #adb5bd; text-decoration: none; border-left: 4px solid transparent; cursor: pointer;
        }
        .sidebar a:hover { background: #343a40; color: white; }
        .sidebar a.active { background: #343a40; color: #198754; border-left-color: #198754; }

        /* HEADER (Barra Superior) */
        .navbar-custom {
            height: 60px; position: fixed; top: 0; left: 0; right: 0;
            background: #198754; z-index: 1000; padding: 0 20px;
            display: flex; align-items: center; justify-content: space-between;
            color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* CONTENIDO PRINCIPAL */
        .content { margin-left: 240px; margin-top: 60px; padding: 30px; transition: 0.3s; }

        /* PESTAÑAS (Visibilidad) */
        .section-view { display: none !important; }
        .section-view.active { display: block !important; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* TABLAS */
        .table th, .table td { vertical-align: middle; }
        .btn-action { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; }

        /* RESPONSIVE */
        @media(max-width: 768px) {
            .sidebar { left: -240px; }
            .sidebar.active { left: 0; }
            .content { margin-left: 0; }
        }
    </style>
</head>
<body>

<div class="navbar-custom">
    <div class="d-flex align-items-center">
        <button class="btn text-white d-md-none me-2" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <span class="fw-bold fs-5"><i class="fas fa-gem me-2"></i>Diamante Azul (Empleado)</span>
    </div>
    <div class="d-flex align-items-center gap-3">
        <span class="d-none d-sm-inline" th:text="${usuario_nombre}">Empleado</span>
        <form th:action="@{/logout}" method="post" class="m-0">
            <button class="btn btn-sm btn-outline-light">Salir</button>
        </form>
    </div>
</div>

<div class="sidebar" id="sidebar">
    <a onclick="showSection('dashboard', this)" class="active"><i class="fas fa-tachometer-alt me-2"></i>Resumen</a>
    <a onclick="showSection('empenos', this)"><i class="fas fa-hand-holding-usd me-2"></i>Empeños</a>
    <a onclick="showSection('cuotas', this)"><i class="fas fa-file-invoice-dollar me-2"></i>Cuotas</a>
    <a onclick="showSection('productos', this)"><i class="fas fa-box me-2"></i>Productos</a>
    <div style="border-top: 1px solid #444; margin: 10px 0;"></div>
    <a onclick="showSection('reportes', this)"><i class="fas fa-file-download me-2"></i>Reportes</a>
</div>

<div class="content">

    <div id="dashboard-section" class="section-view active">
        <h4 class="mb-4">Resumen General</h4>
        <div class="row g-3">
            <div class="col-md-4"><div class="card bg-success text-white p-3 shadow-sm border-0"><h3><i class="fas fa-check"></i> <span th:text="${totalEmpenos}">0</span></h3><p>Empeños Activos</p></div></div>
            <div class="col-md-4"><div class="card bg-warning text-dark p-3 shadow-sm border-0"><h3><i class="fas fa-clock"></i> <span th:text="${cuotasVencidas}">0</span></h3><p>Cuotas Vencidas</p></div></div>
            <div class="col-md-4"><div class="card bg-primary text-white p-3 shadow-sm border-0"><h3><i class="fas fa-box"></i> <span th:text="${totalProductos}">0</span></h3><p>Productos</p></div></div>
        </div>
    </div>

    <div id="empenos-section" class="section-view">
        <div class="d-flex justify-content-between mb-3">
            <h4>Gestión de Empeños</h4>
            <button class="btn btn-success" onclick="abrirModalEmpeno()"><i class="fas fa-plus"></i> Nuevo</button>
        </div>
        <div class="card p-3 shadow-sm border-0">
            <input type="text" class="form-control form-control-sm mb-3" placeholder="Buscar..." onkeyup="buscar('empenos', this.value)">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-dark"><tr><th>ID</th><th>Cliente</th><th>Producto</th><th>Monto</th><th>Estado</th><th class="text-end">Acción</th></tr></thead>
                    <tbody id="tablaEmpenosBody">
                    <tr th:each="e : ${empenos}">
                        <td th:text="${e.id}"></td>
                        <td th:text="${e.cliente?.nombre}"></td>
                        <td th:text="${e.producto?.nombre}"></td>
                        <td th:text="${e.montoPrestado}"></td>
                        <td><span class="badge bg-success" th:text="${e.estadoEmpeno}"></span></td>
                        <td class="text-end">
                            <button class="btn btn-warning btn-action text-white shadow-sm"
                                    th:data-id="${e.id}" th:data-cli="${e.cliente?.id}" th:data-prod="${e.producto?.id}"
                                    th:data-monto="${e.montoPrestado}" th:data-tasa="${e.tasaInteres}" th:data-venc="${e.fechaVencimiento}"
                                    onclick="editarEmpeno(this)"><i class="fas fa-pen fa-xs"></i></button>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(empenos)}"><td colspan="6" class="text-center py-4 text-muted">No hay empeños registrados.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="cuotas-section" class="section-view">
        <div class="d-flex justify-content-between mb-3">
            <h4>Gestión de Cuotas</h4>
            <button class="btn btn-info text-white" onclick="abrirModalCuota()"><i class="fas fa-plus"></i> Registrar Pago</button>
        </div>
        <div class="card p-3 shadow-sm border-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-dark"><tr><th>ID</th><th>Empeño</th><th>Valor</th><th>Estado</th><th class="text-end">Acción</th></tr></thead>
                    <tbody id="tablaCuotasBody">
                    <tr th:each="c : ${cuotas}">
                        <td th:text="${c.idCuota}"></td>
                        <td th:text="'#'+${c.empeno?.id}"></td>
                        <td th:text="${c.valorCuota}"></td>
                        <td th:text="${c.estadoCuota}"></td>
                        <td class="text-end">
                            <button class="btn btn-warning btn-action text-white shadow-sm"
                                    th:data-id="${c.idCuota}"
                                    th:data-emp="${c.empeno?.id}"
                                    th:data-val="${c.valorCuota}"
                                    th:data-est="${c.estadoCuota}"
                                    th:data-num="${c.numeroCuota}"
                                    onclick="editarCuota(this)">
                                <i class="fas fa-pen fa-xs"></i>
                            </button>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(cuotas)}"><td colspan="5" class="text-center py-4 text-muted">No hay cuotas registradas.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="productos-section" class="section-view">
        <div class="d-flex justify-content-between mb-3">
            <h4>Inventario de Productos</h4>
            <button class="btn btn-secondary" onclick="abrirModalProducto()"><i class="fas fa-plus"></i> Nuevo</button>
        </div>
        <div class="card p-3 shadow-sm border-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-dark"><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Estado</th><th class="text-end">Acción</th></tr></thead>
                    <tbody id="tablaProductosBody">
                    <tr th:each="p : ${productos}">
                        <td th:text="${p.id}"></td>
                        <td th:text="${p.nombre}"></td>
                        <td th:text="${p.precio}"></td>
                        <td th:text="${p.estado}"></td> <td class="text-end">
                        <button class="btn btn-warning btn-action text-white shadow-sm"
                                th:data-id="${p.id}" th:data-nom="${p.nombre}" th:data-desc="${p.descripcion}"
                                th:data-pre="${p.precio}" th:data-est="${p.estado}"
                                onclick="editarProducto(this)"><i class="fas fa-pen fa-xs"></i></button>
                    </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(productos)}"><td colspan="5" class="text-center py-4 text-muted">No hay productos.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reportes-section" class="section-view">
        <h4>Reportes</h4>
        <div class="row g-3">
            <div class="col-md-6"><div class="card p-4 text-center shadow-sm border-0"><i class="fas fa-file-pdf fa-3x text-danger mb-3"></i><h5>Vencidos</h5><a href="#" class="btn btn-outline-danger w-100">Descargar PDF</a></div></div>
            <div class="col-md-6"><div class="card p-4 text-center shadow-sm border-0"><i class="fas fa-box fa-3x text-primary mb-3"></i><h5>Inventario</h5><a href="#" class="btn btn-outline-primary w-100">Descargar Lista</a></div></div>
        </div>
    </div>

</div>

<div class="modal fade" id="modalEmpeno" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-success text-white py-2"><h6>Empeño</h6><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <form id="fEmp"><input type="hidden" id="eId">
            <label class="small fw-bold">Cliente</label><select id="eCli" class="form-select form-select-sm mb-2"><option th:each="c:${clientesDisponibles}" th:value="${c.id}" th:text="${c.nombre}"></option></select>
            <label class="small fw-bold">Producto</label><select id="eProd" class="form-select form-select-sm mb-2"><option th:each="p:${productos}" th:value="${p.id}" th:text="${p.nombre}"></option></select>
            <div class="row"><div class="col"><label class="small fw-bold">Monto</label><input type="number" id="eMon" class="form-control form-control-sm"></div><div class="col"><label class="small fw-bold">Tasa</label><input type="number" id="eTas" class="form-control form-control-sm" value="5"></div></div>
            <label class="small fw-bold mt-2">Vencimiento</label><input type="date" id="eVen" class="form-control form-control-sm">
        </form>
    </div>
    <div class="modal-footer py-1"><button onclick="saveEmp()" class="btn btn-success w-100">Guardar</button></div>
</div></div></div>

<div class="modal fade" id="modalCuota" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-info text-white py-2"><h6>Cuota</h6><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <form id="fCuo"><input type="hidden" id="cId">
            <label class="small fw-bold">Empeño</label>
            <select id="cEmp" class="form-select form-select-sm mb-2">
                <option value="">-- Seleccione --</option>
                <option th:each="e:${empenos}" th:value="${e.id}" th:text="'#' + ${e.id} + ' - ' + ${e.cliente?.nombre}"></option>
            </select>
            <div class="row">
                <div class="col"><label class="small fw-bold">N° Cuota</label><input type="number" id="cNum" class="form-control form-control-sm mb-2" value="1"></div>
                <div class="col"><label class="small fw-bold">Valor</label><input type="number" id="cVal" class="form-control form-control-sm mb-2"></div>
            </div>
            <label class="small fw-bold">Estado</label>
            <select id="cEst" class="form-select form-select-sm mb-2"><option value="PENDIENTE">PENDIENTE</option><option value="PAGADA">PAGADA</option></select>
            <label class="small fw-bold">Fecha Pago</label><input type="date" id="cFecha" class="form-control form-control-sm">
        </form>
    </div>
    <div class="modal-footer py-1"><button onclick="saveCuo()" class="btn btn-info text-white w-100">Guardar</button></div>
</div></div></div>

<div class="modal fade" id="modalProducto" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-secondary text-white py-2"><h6>Producto</h6><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <form id="fProd"><input type="hidden" id="pId">
            <label class="small fw-bold">Nombre</label><input type="text" id="pNom" class="form-control form-control-sm mb-2">
            <label class="small fw-bold">Precio</label><input type="number" id="pPre" class="form-control form-control-sm mb-2">
            <label class="small fw-bold">Descripción</label><textarea id="pDes" class="form-control form-control-sm mb-2"></textarea>
            <label class="small fw-bold">Estado</label>
            <select id="pEst" class="form-select form-select-sm"><option value="DISPONIBLE">DISPONIBLE</option><option value="EMPEÑADO">EMPEÑADO</option></select>
        </form>
    </div>
    <div class="modal-footer py-1"><button onclick="saveProd()" class="btn btn-secondary w-100">Guardar</button></div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const csrfToken = document.querySelector("meta[name='_csrf']")?.getAttribute("content");
    const csrfHeader = document.querySelector("meta[name='_csrf_header']")?.getAttribute("content");

    // NAVEGACIÓN
    function showSection(id, btn) {
        document.querySelectorAll('.section-view').forEach(s => s.classList.remove('active'));
        document.getElementById(id+'-section').classList.add('active');
        document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('active');
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

    // --- FUNCIONES GUARDAR (CORREGIDAS) ---

    // 1. Empeño
    function abrirModalEmpeno() { document.getElementById('fEmp').reset(); document.getElementById('eId').value=''; new bootstrap.Modal(document.getElementById('modalEmpeno')).show(); }
    function editarEmpeno(btn) {
        document.getElementById('eId').value = btn.dataset.id; document.getElementById('eCli').value = btn.dataset.cli;
        document.getElementById('eProd').value = btn.dataset.prod; document.getElementById('eMon').value = btn.dataset.monto;
        document.getElementById('eTas').value = btn.dataset.tasa; document.getElementById('eVen').value = btn.dataset.venc;
        new bootstrap.Modal(document.getElementById('modalEmpeno')).show();
    }
    function saveEmp() { post('/dashboard/empleado/empenos/guardar', {
        id: document.getElementById('eId').value, clienteId: document.getElementById('eCli').value,
        productoId: document.getElementById('eProd').value, usuarioId: 1, montoPrestado: document.getElementById('eMon').value,
        tasaInteres: document.getElementById('eTas').value, fechaVencimiento: document.getElementById('eVen').value
    }); }

    // 2. Cuota (Validada y con nulos)
    function abrirModalCuota() { document.getElementById('fCuo').reset(); document.getElementById('cId').value=''; document.getElementById('cNum').value='1'; new bootstrap.Modal(document.getElementById('modalCuota')).show(); }
    function editarCuota(btn) {
        document.getElementById('cId').value = btn.dataset.id; document.getElementById('cEmp').value = btn.dataset.emp;
        document.getElementById('cVal').value = btn.dataset.val; document.getElementById('cNum').value = btn.dataset.num || 1;
        document.getElementById('cEst').value = btn.dataset.est; new bootstrap.Modal(document.getElementById('modalCuota')).show();
    }
    function saveCuo() {
        let idVal = document.getElementById('cId').value;
        let empVal = document.getElementById('cEmp').value;
        let valVal = document.getElementById('cVal').value;
        let numVal = document.getElementById('cNum').value;
        let fechaVal = document.getElementById('cFecha').value;

        if(!empVal || !valVal) { alert("Complete los campos obligatorios"); return; }

        post('/dashboard/empleado/cuotas/guardar', {
            idCuota: idVal ? parseInt(idVal) : null,
            empenoId: parseInt(empVal),
            numeroCuota: numVal ? parseInt(numVal) : 1,
            valorCuota: parseFloat(valVal),
            estadoCuota: document.getElementById('cEst').value,
            fechaPago: fechaVal ? fechaVal : null
        });
    }

    // 3. Producto (Nombres corregidos)
    function abrirModalProducto() { document.getElementById('fProd').reset(); document.getElementById('pId').value=''; document.getElementById('pEst').value='DISPONIBLE'; new bootstrap.Modal(document.getElementById('modalProducto')).show(); }
    function editarProducto(btn) {
        document.getElementById('pId').value = btn.dataset.id; document.getElementById('pNom').value = btn.dataset.nom;
        document.getElementById('pDes').value = btn.dataset.desc; document.getElementById('pPre').value = btn.dataset.pre;
        document.getElementById('pEst').value = btn.dataset.est; new bootstrap.Modal(document.getElementById('modalProducto')).show();
    }
    function saveProd() {
        let idVal = document.getElementById('pId').value;
        post('/dashboard/empleado/productos/guardar', {
            id: idVal ? parseInt(idVal) : null,
            nombre: document.getElementById('pNom').value,
            descripcion: document.getElementById('pDes').value,
            precio: parseFloat(document.getElementById('pPre').value),
            estado: document.getElementById('pEst').value
        });
    }

    function post(url, data) {
        fetch(url, {method:'POST', headers:{'Content-Type':'application/json', [csrfHeader]:csrfToken}, body:JSON.stringify(data)})
        .then(r=>{if(r.ok) location.reload(); else alert("Error al guardar");}).catch(e=>alert("Error conexión"));
    }

    function buscar(tipo, val) {
        let rows = document.getElementById(`tabla${tipo.charAt(0).toUpperCase()+tipo.slice(1)}Body`).getElementsByTagName("tr");
        for(let tr of rows) tr.style.display = tr.innerText.toUpperCase().indexOf(val.toUpperCase()) > -1 ? "" : "none";
    }
</script>
</body>
</html>